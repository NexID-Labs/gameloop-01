<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Spyfall Game - Lobby</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/css/bootstrap.min.css" rel="stylesheet"
    crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <link href="custom/custom.css" rel="stylesheet" type="text/css">
  <style>
    body {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
 background-size: cover;
  background-repeat: no-repeat;
  background-position: center center;
  transition: background-image 1s ease-in-out;
    }

    .crown {
      font-size: 1.2rem;
      margin-left: 5px;
    }

    #copyBtn {
      cursor: pointer;
      margin-left: 5px;
    }

    /* Ad Banner Styles */
    .ad-banner {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 60px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      /*box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);*/
    }

    .ad-content {
      color: white;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
    }

    .ad-text {
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    @media (max-width: 768px) {
      .ad-banner {
        height: 50px;
      }

      .ad-content {
        font-size: 14px;
      }
    }
  </style>
</head>

<body>
<script>
        document.addEventListener("DOMContentLoaded", function () {
const backgrounds=[ "gallary/picture/1.PNG",
    "gallary/picture/2.PNG",
    "gallary/picture/3.PNG",
    "gallary/picture/4.PNG",
    "gallary/picture/5.PNG",
    "gallary/picture/6.PNG",
    "gallary/picture/7.PNG",
    "gallary/picture/8.PNG",
    "gallary/picture/9.PNG",
    "gallary/picture/10.PNG",
    "gallary/picture/11.PNG",
    "gallary/picture/12.PNG",
    "gallary/picture/13.PNG",
    "gallary/picture/14.PNG",
    "gallary/picture/15.PNG",
        "gallary/picture/16.PNG",
    "gallary/picture/17.PNG",
    "gallary/picture/18.PNG"
    ];

    const selectedBg = backgrounds[Math.floor(Math.random() * backgrounds.length)];

    document.body.style.backgroundImage = `url('${selectedBg}')`;
  });
</script>
  <!-- Top Ad Banner -->
  <div class="ad-banner">
    <div class="ad-content">
      <span class="ad-text">🎮 Your Ad Here - Premium Gaming Experience</span>
    </div>
  </div>

  <div class="text-center w-100" style="max-width: 400px; margin-top: 70px;">
    <h3>منتظرين اللاعبين</h3>
    <hr>

    <p class="mb-1"><strong>رمز الدخول:</strong> <span id="accessCode"></span>
      <i id="copyBtn" class="bi bi-clipboard" title="Copy full URL to clipboard"></i>
    </p>

    <hr>
    <p class="mb-1"><strong>اعدادات الآدمن</strong></p>
    <div id="playersContainer" class="mb-3"></div>

    <hr id="hostSettingsHR" style="display:none;">
    <p id="hostSettingsLabel" class="mb-1" style="display:none;"><strong>إعدادات المضيف</strong></p>

    <select id="questionLimitSelect" class="form-select mb-2" style="display:none;">
      <option value="20">	٢٠ سؤال</option>
      <option value="40">٤٠ سؤال
</option>
      <option value="60"> ٦٠ سؤال
</option>
      <option value="80">٨٠ سؤال
</option>
      <option value="100"> ١٠٠ سؤال
</option>
    </select>

    <button id="startGameBtn" class="btn btn-outline-dark mt-2" style="display:none;">ابدأ اللعبة
</button>

    <p id="questionLimitDisplay" class="text-primary mt-2"></p>
    <p id="statusText" class="text-secondary mt-1">0/0 اللاعبين جاهزين</p>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/socket.io-client@4.0.0/dist/socket.io.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.6/dist/js/bootstrap.bundle.min.js"
    crossorigin="anonymous"></script>

  <script>
    // Load environment variables
    // const env = {};
    // fetch('/.env')
    //   .then(response => response.text())
    //   .then(data => {
    //     const lines = data.split('\n');
    //     lines.forEach(line => {
    //       const [key, value] = line.split('=');
    //       if (key && value) {
    //         env[key.trim()] = value.trim();
    //       }
    //     });
    //   });

    // const socket = io.connect(env.BACKEND_URL);
    const BACKEND_URL = "http://localhost:5000";

    const socket = io(BACKEND_URL, {
    transports: ["websocket", "polling"]
  });

    const urlParams = new URLSearchParams(window.location.search);
    const accessCode = urlParams.get('code') || 'N/A';
    console.log('Access Code:', accessCode);
    document.getElementById('accessCode').textContent = accessCode;

    const playersContainer = document.getElementById('playersContainer');
    const statusText = document.getElementById('statusText');
    const startGameBtn = document.getElementById('startGameBtn');
    const questionLimitSelect = document.getElementById('questionLimitSelect');
    const questionLimitDisplay = document.getElementById('questionLimitDisplay');

    // Ad system
    let currentAds = [];
    let currentAdIndex = 0;

    function loadAdsFromBackend() {
      fetch(`http://localhost:5000/api/admin/ads`)
        .then(response => response.json())
        .then(ads => {
          currentAds = ads.filter(ad => ad.status === 'active');
          console.log('Loaded active ads from backend:', currentAds.length);

          if (currentAds.length === 0) {
            currentAds = [{
              title: "Default Ad",
              content: "🎮 Your Ad Here - Premium Gaming Experience",
              url: ""
            }];
          }

          initializeAdRotation();
        })
        .catch(error => {
          console.error('Error loading ads:', error);
          currentAds = [{
            title: "Default Ad",
            content: "🎮 Your Ad Here - Premium Gaming Experience",
            url: ""
          }];
          initializeAdRotation();
        });
    }

    function initializeAdRotation() {
      if (currentAds.length > 0) {
        updateAdBanner();

        if (currentAds.length > 1) {
          setInterval(() => {
            currentAdIndex = (currentAdIndex + 1) % currentAds.length;
            updateAdBanner();
          }, 30000);
        }
      }
    }

    function updateAdBanner() {
      const adText = document.querySelector('.ad-text');
      if (currentAds.length > 0) {
        const currentAd = currentAds[currentAdIndex];
        adText.textContent = currentAd.content;
      }
    }

    loadAdsFromBackend();

    let allPlayers = {};
    let hostName = null;
    let savedPlayerName = null;

    // Join the game room
    socket.emit('joinGame', accessCode);

    // Listen for game data
    socket.on('gameData', (game) => {
      console.log('Game data received:', game); 
      if (!game) {
        alert("Game not found.");
        window.location.href = "index.html";
        return;
      }

      savedPlayerName = localStorage.getItem('playerName');
      initializeLobby(savedPlayerName);
    });

    // Listen for game not found
    socket.on('gameNotFound', (data) => {
      alert(data.message);
      window.location.href = "index.html";
    });

    // Listen for player joined
    socket.on('playerJoined', (data) => {
      console.log('Player joined:', data.playerId);
    });

    function initializeLobby(name) {
      savedPlayerName = name;

      // Fetch game data from the backend
      fetch(`http://localhost:5000/api/game/${accessCode}`)
        .then(response => response.json())
        .then(game => {
          if (game.host) {
            hostName = game.host;
          }

          if (localStorage.getItem('hostNameFor_') === "host") {
            document.getElementById('hostSettingsHR').style.display = 'block';
            document.getElementById('hostSettingsLabel').style.display = 'block';
            questionLimitSelect.style.display = 'block';
            startGameBtn.style.display = 'inline-block';

            // Set initial question limit
            questionLimitSelect.value = game.questionLimit || 20;
            questionLimitDisplay.textContent = `Questions: ${questionLimitSelect.value}`;
          }

          // Update players list
          allPlayers = game.players || [];
          renderPlayers();

          // Listen for real-time updates
          socket.on('gameUpdated', (updatedGame) => {
            allPlayers = updatedGame.players || [];
            renderPlayers();

            const readyCount = Object.keys(updatedGame.playersReady || {}).length;
            const totalCount = allPlayers.length;
            statusText.innerText = `${readyCount}/${totalCount} players ready`;

            if (localStorage.getItem('hostNameFor_') === "host") {
              startGameBtn.disabled = totalCount < 2;
            }
          });
        })
        .catch(error => {
          console.error('Error fetching game data:', error);
          alert("Error accessing game.");
          window.location.href = "index.html";
        });

      function renderPlayers() {
        playersContainer.innerHTML = "";
        const playerNames = allPlayers;
        const orderedPlayers = [];

        if (playerNames.includes(savedPlayerName)) orderedPlayers.push(savedPlayerName);
        playerNames.forEach(name => {
          if (name !== savedPlayerName) orderedPlayers.push(name);
        });

        orderedPlayers.forEach(player => {
          const playerBox = document.createElement("div");
          playerBox.className = "player-box my-1 mx-auto";
          playerBox.textContent = player;

          if (player === hostName) {
            playerBox.innerHTML += ' <span class="crown">👑</span>';
          }

          playersContainer.appendChild(playerBox);
        });
      }

      questionLimitSelect.addEventListener('change', () => {
        const selectedLimit = parseInt(questionLimitSelect.value);
        questionLimitDisplay.textContent = `Questions: ${selectedLimit}`;

        // Update question limit in the backend
        fetch(`http://localhost:5000/api/game/${accessCode}/questionLimit`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ questionLimit: selectedLimit })
        })
        .catch(error => {
          console.error('Error updating question limit:', error);
        });
      });

      socket.on('gameStarted', () => {
        window.location.href = `finalpage.html?code=${accessCode}`;
      });
    }

    startGameBtn.addEventListener('click', () => {
      // Start the game
      socket.emit('startGame', accessCode);
    });

    document.getElementById('copyBtn').addEventListener('click', () => {
      const fullURL = `${window.location.origin}/nextpage.html?code=${accessCode}`;
      navigator.clipboard.writeText(fullURL)
        .then(() => alert("Game URL copied to clipboard!"))
        .catch(() => alert("Failed to copy URL."));
    });
  </script>
</body>

</html>
